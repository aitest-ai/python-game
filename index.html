<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ•´åˆ GenAI éŠæˆ²è¨­è¨ˆå­¸ç¿’ç³»çµ± (V21.0 Structured Thinking)</title>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* (æ¨£å¼ç¶­æŒ V19.4 é¢¨æ ¼) */
        :root { --bg-color: #f4f7f6; --panel-bg: #ffffff; --text: #2c3e50; --border: #e0e0e0; --accent: #5dade2; --accent-hover: #3498db; --chat-header: #eef2f5; --chat-user-bg: #fdf6e3; --chat-ai-bg: #ffffff; --btn-scamper-bg: #e8e4d9; --btn-scamper-text: #5d5648; }
        @font-face { font-family: 'Iansui'; font-style: normal; font-weight: 400; font-display: swap; src: url('https://cdn.jsdelivr.net/fontsource/fonts/iansui@latest/chinese-traditional-400-normal.woff2') format('woff2'); }
        body { background: var(--bg-color); color: var(--text); font-family: 'Iansui','Microsoft JhengHei', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { background: #fff; border-bottom: 1px solid var(--border); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .brand { font-size: 1.2em; font-weight: bold; color: #34495e; display: flex; align-items: center; gap: 10px; }
        .brand-icon { width: 32px; height: 32px; background: var(--accent); color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9em; }
        .main-container { flex: 1; display: flex; flex-direction: column; padding: 20px 40px; overflow: hidden; position: relative; }
        .nav-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 0; }
        .tab-btn { background: transparent; border: none; color: #95a5a6; padding: 10px 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; font-family: 'Iansui'; }
        .tab-btn:hover { color: var(--accent); }
        .tab-btn.active { color: var(--text); border-bottom: 3px solid var(--accent); }
        .content-area { display: none; flex: 1; flex-direction: column; overflow-y: auto; height: 100%; }
        .content-area.active { display: flex; }
        .ideate-layout { display: flex; height: 100%; gap: 25px; }
        .note-panel { flex: 1; display: flex; flex-direction: column; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .note-title { font-size: 1.2em; font-weight: bold; color: #444; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .note-status { font-size: 0.7em; color: #aaa; font-weight: normal; }
        .note-input { flex: 1; border: none; resize: none; font-size: 1.1em; line-height: 1.8; color: #555; outline: none; font-family: 'Iansui'; background: url('data:image/svg+xml;utf8,<svg width="100" height="30" xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="29" x2="100" y2="29" stroke="%23f0f0f0" stroke-width="1"/></svg>'); background-attachment: local; transition: background-color 0.3s; }
        .note-input.highlight { background-color: #fffde7; }
        .chat-panel { width: 420px; display: flex; flex-direction: column; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .chat-header { background: var(--chat-header); padding: 15px 20px; font-weight: bold; color: #555; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .chat-badge { background: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #888; border: 1px solid #ddd; }
        #ideate-chat-box { flex: 1; padding: 20px; overflow-y: auto; background: #fdfdfd; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { padding: 12px 18px; border-radius: 12px; max-width: 85%; line-height: 1.5; font-size: 0.95em; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .msg.user { background: var(--chat-user-bg); color: #4a4a4a; align-self: flex-end; border: 1px solid var(--chat-user-border); border-top-right-radius: 2px; }
        .msg.ai { background: var(--chat-ai-bg); color: #333; align-self: flex-start; border: 1px solid var(--chat-ai-border); border-top-left-radius: 2px; }
        .msg-label { display: block; font-weight: bold; font-size: 0.85em; margin-bottom: 5px; color: #666; opacity: 0.8; }
        .btn-adopt { display: block; margin-top: 8px; font-size: 0.85em; padding: 4px 10px; background: #e1f5fe; color: #0277bd; border: 1px solid #b3e5fc; border-radius: 4px; cursor: pointer; text-align: center; transition: 0.2s; }
        .btn-adopt:hover { background: #b3e5fc; }
        .btn-adopt:disabled { background: #eee; color: #999; cursor: wait; border-color: #ddd; } /* V21.0 Loading Style */
        .chat-footer { padding: 15px; background: #fff; border-top: 1px solid var(--border); }
        .scamper-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .scamper-btn { background: var(--btn-scamper-bg); color: var(--btn-scamper-text); border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; font-weight: bold; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .scamper-btn:hover { background: #dcd6c5; }
        .input-box { display: flex; gap: 10px; margin-top: 5px; }
        .chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ccc; border-radius: 20px; font-size: 0.95em; background: #f9f9f9; }
        .chat-input:focus { background: #fff; border-color: var(--accent); }
        .workspace-grid { display: grid; grid-template-columns: 1fr 480px; gap: 25px; height: 100%; }
        .ide-container { display: flex; flex-direction: column; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .ide-toolbar { background: #f4f4f4; padding: 8px 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .file-tab { background: #fff; padding: 5px 15px; border-radius: 4px 4px 0 0; border: 1px solid #ccc; border-bottom: none; font-size: 0.85em; color: #555; font-weight: bold; margin-bottom: -9px; position: relative; z-index: 5; }
        .code-area { flex: 1; background: #ffffff; color: #333; padding: 15px; border: none; font-family: 'Consolas', 'Monaco', monospace; resize: none; font-size: 15px; line-height: 1.6; outline: none; }
        .console-area { height: 120px; background: #f8f9fa; color: #555; padding: 10px; font-family: monospace; overflow-y: auto; border-top: 1px solid #ccc; font-size: 0.9em; }
        .game-preview-container { display: flex; flex-direction: column; gap: 10px; background: #f4f7f6; transition: background 0.3s; }
        .game-preview-container:fullscreen { background: #000; display: flex; justify-content: center; align-items: center; padding: 0; }
        .game-preview-container:fullscreen #game-canvas { width: auto; height: 100vh; max-width: 100vw; border: none; box-shadow: none; margin: 0; }
        .game-preview-container:fullscreen .asset-box, .game-preview-container:fullscreen .preview-label { display: none; }
        #game-canvas { background: #000; border: 4px solid #333; border-radius: 4px; width: 100%; height: auto; aspect-ratio: 900/520; margin: 0 auto; display: block; image-rendering: pixelated; box-shadow: 0 10px 30px rgba(0,0,0,0.15); outline: none; box-sizing: content-box; }
        #game-canvas:focus { border-color: var(--accent); }
        .asset-box { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px; flex: 1; display: flex; flex-direction: column; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(93, 173, 226, 0.4); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn-primary:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; }
        .btn-danger { background: #e74c3c; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.4); }
        .btn-danger:hover { background: #c0392b; }
        .btn-dark { background: #34495e; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(52, 73, 94, 0.4); display: flex; align-items: center; gap: 5px; }
        .btn-dark:hover { background: #2c3e50; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
    </style>
</head>
<body>
    
    <div id="login-overlay" class="overlay">
        <h1 style="margin-bottom: 5px; color:#2c3e50;">æ•´åˆ GenAI éŠæˆ²è¨­è¨ˆå­¸ç¿’ç³»çµ±</h1>
        <div style="background:#f0f0f0; padding:5px 15px; border-radius:20px; font-size:0.9em; margin-bottom:30px; color:#666; border:1px solid #ccc;">V21.0 Structured Thinking</div>
        <input type="text" id="student-id" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" style="padding:12px; width:280px; text-align:center; border:1px solid #ccc; border-radius:6px; margin-bottom:15px; font-size:1.1em; outline:none;">
        <button id="btn-start" class="btn-primary" style="width:300px; padding:12px;" onclick="startSystem()">å•Ÿå‹•ç³»çµ± (å«å¤–éƒ¨åº«) â–¶</button>
        <div id="loading-msg" style="margin-top:10px; color:#999; font-size:0.8em;">æº–å‚™è¼‰å…¥ Numpy & PIL...</div>
    </div>

    <div class="top-bar">
        <div class="brand">
            <div class="brand-icon">G</div>
            <span>å…±å‰µå¯¦é©—å®¤</span>
        </div>
        <div style="font-size:0.9em; color:#7f8c8d;">
            Python 3.10 â€¢ Pygame Web Engine
        </div>
    </div>

    <div class="main-container">
        <div class="nav-tabs">
            <button class="tab-btn" onclick="switchTab('learning')">1. åŸºç¤å­¸ç¿’</button>
            <button class="tab-btn active" onclick="switchTab('ideate')">2. å‰µæ„ç™¼æƒ³</button>
            <button class="tab-btn" onclick="switchTab('prototype')">3. åŸå‹å¯¦ä½œ</button>
            <button class="tab-btn" onclick="switchTab('evaluate')">4. é›™é‡è©•é‡</button>
            <button class="tab-btn" onclick="switchTab('reflect')">5. åæ€ä¿®æ­£</button>
        </div>

        <div id="tab-learning" class="content-area"><h3>ğŸ“– å–®å…ƒä¸€ï¼šPygame åŸºç¤</h3><div style="background:#fff; height:400px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; color:#999; border-radius:8px;"><h2>[ æ¨¡æ“¬å½±ç‰‡æ’­æ”¾å™¨ ]</h2></div></div>

        <div id="tab-ideate" class="content-area active">
            <div class="ideate-layout">
                <div class="note-panel">
                    <div class="note-title">
                        ğŸ“ éŠæˆ²è¨­è¨ˆç­†è¨˜
                        <span class="note-status" id="save-status">æœªåŒæ­¥</span>
                    </div>
                    <textarea id="design-notes" class="note-input" placeholder="è«‹åœ¨æ­¤è¨˜éŒ„æ‚¨çš„éŠæˆ²æ§‹æƒ³...&#10;AI å»ºè­°çš„é»å­å¯ä»¥é€éæŒ‰éˆ•æ•´ç†å¾ŒåŠ å…¥ã€‚" oninput="handleNoteChange()"></textarea>
                </div>
                <div class="chat-panel">
                    <div class="chat-header"><span>ğŸ¤ AI å‰µæ„å¤¥ä¼´</span><span class="chat-badge">Online</span></div>
                    <div id="ideate-chat-box"><div class="msg ai"><span class="msg-label">ğŸ¤– å¤¥ä¼´</span>å—¨ï¼æˆ‘æ˜¯ä½ çš„è¨­è¨ˆå¤¥ä¼´ã€‚æˆ‘å€‘å¯ä»¥ä¸€èµ·ç”¨ SCAMPER æ–¹æ³•ä¾†è…¦åŠ›æ¿€ç›ªã€‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å§ï¼</div></div>
                    <div class="chat-footer">
                        <div class="scamper-group">
                            <button class="scamper-btn" onclick="triggerScamper('Substitute')">ğŸ“„ æ›¿ä»£</button>
                            <button class="scamper-btn" onclick="triggerScamper('Combine')">ğŸ”— åˆä½µ</button>
                            <button class="scamper-btn" onclick="triggerScamper('Reverse')">â†©ï¸ é€†å‘</button>
                            <button class="scamper-btn" onclick="triggerScamper('Modify')">âœï¸ ä¿®æ”¹</button>
                        </div>
                        <div class="input-box"><input id="ideate-input" class="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key === 'Enter') mockUserResponse()"><button class="btn-primary" style="padding: 8px 15px; border-radius:50%; width:40px; height:40px; display:flex; justify-content:center; align-items:center;" onclick="mockUserResponse()">âœ</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-prototype" class="content-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#333;">ğŸ› ï¸ åŸå‹è£½ä½œ (Pygame)</h3>
                <div style="display:flex; gap:10px;">
                    <button id="btn-fullscreen" class="btn-dark" onclick="toggleFullscreen()">â›¶ å…¨è¢å¹•</button>
                    <div style="width:1px; background:#ccc; margin:0 5px;"></div>
                    <button id="btn-run" class="btn-primary" onclick="runGame()" disabled>â³ è¼‰å…¥ä¸­...</button>
                    <button class="btn-danger" onclick="stopGame()">â¹ åœæ­¢</button>
                </div>
            </div>
            
            <div class="workspace-grid">
                <div class="ide-container">
                    <div class="ide-toolbar"><div class="file-tab">main.py</div><span style="font-size:0.8em; color:#888;">Python 3.10 (Pyodide + Numpy + PIL)</span></div>
                    <textarea id="game-code" class="code-area">
import pygame
import random
import asyncio
import sys

# ====== æ¸¬è©¦ç¯„ä¾‹ï¼šå¤ªç©ºè·‘é…· ======
W, H = 900, 520
FPS = 60
GROUND_Y = 420
PLAYER_W, PLAYER_H = 36, 44
GRAVITY = 1.1
JUMP_V = -17
OB_MIN_W, OB_MAX_W = 26, 60
OB_H = 48
SPAWN_OB_EVERY_MS = 900

def clamp(v, lo, hi): return max(lo, min(v, hi))
def should_stop(): return bool(getattr(sys, "_web_stop", False))
def new_obstacle(speed):
    rect = pygame.Rect(W + random.randint(0, 120), GROUND_Y - OB_H, random.randint(OB_MIN_W, OB_MAX_W), OB_H)
    return {"rect": rect, "vx": -speed}
def reset_game():
    return pygame.Rect(140, GROUND_Y - PLAYER_H, PLAYER_W, PLAYER_H), 0.0, True, [], 0, pygame.time.get_ticks(), 7.0, False

async def main():
    pygame.init()
    screen = pygame.display.set_mode((W, H))
    pygame.display.set_caption("è·‘é…·è·³èº")
    clock = pygame.time.Clock()
    font = pygame.font.SysFont(None, 30)
    big = pygame.font.SysFont(None, 68)
    OB_EVENT = pygame.USEREVENT + 1
    def start_timer(ms): pygame.time.set_timer(OB_EVENT, ms)
    def stop_timer(): pygame.time.set_timer(OB_EVENT, 0)

    player, vy, on_ground, obstacles, score, start_ticks, speed, game_over = reset_game()
    start_timer(SPAWN_OB_EVERY_MS)

    while True:
        await asyncio.sleep(0)
        if should_stop(): stop_timer(); pygame.quit(); return
        now = pygame.time.get_ticks()
        t = (now - start_ticks) / 1000.0
        jump_pressed = False

        for event in pygame.event.get():
            if event.type == pygame.QUIT or (event.type == pygame.KEYDOWN and event.key == pygame.K_ESCAPE):
                stop_timer(); pygame.quit(); return
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_r:
                    stop_timer(); pygame.event.clear(); player, vy, on_ground, obstacles, score, start_ticks, speed, game_over = reset_game(); start_timer(SPAWN_OB_EVERY_MS)
                if event.key in (pygame.K_SPACE, pygame.K_UP, pygame.K_w): jump_pressed = True
            if event.type == OB_EVENT and not game_over: obstacles.append(new_obstacle(speed))

        if not game_over:
            speed = 7.0 + min(9.0, t * 0.35)
            start_timer(int(max(420, SPAWN_OB_EVERY_MS - t * 18)))
            if jump_pressed and on_ground: vy = JUMP_V; on_ground = False
            vy += GRAVITY
            player.y += int(vy)
            if player.bottom >= GROUND_Y: player.bottom = GROUND_Y; vy = 0; on_ground = True
            for ob in obstacles: ob["rect"].x += int(ob["vx"])
            obstacles = [ob for ob in obstacles if ob["rect"].right > -80]
            for ob in obstacles:
                if player.colliderect(ob["rect"]): game_over = True; stop_timer(); break
            score = int(t * 10)

        screen.fill((14, 16, 22))
        random.seed(12345)
        for _ in range(50):
            x = random.randint(0, W)
            y = (random.randint(0, H) + (now // 10)) % H
            screen.fill((90, 90, 110), (x, y, 2, 2))

        pygame.draw.rect(screen, (28, 32, 40), (0, GROUND_Y, W, H - GROUND_Y))
        pygame.draw.line(screen, (80, 80, 100), (0, GROUND_Y), (W, GROUND_Y), 2)
        pygame.draw.rect(screen, (70, 180, 255), player, border_radius=8)
        for ob in obstacles: pygame.draw.rect(screen, (220, 70, 70), ob["rect"], border_radius=6)
        
        ui = font.render(f"Score: {score}   Speed: {speed:.1f}", True, (235, 235, 235))
        screen.blit(ui, (16, 14))

        if game_over:
            overlay = pygame.Surface((W, H), pygame.SRCALPHA)
            overlay.fill((0, 0, 0, 170))
            screen.blit(overlay, (0, 0))
            t1 = big.render("GAME OVER", True, (255, 255, 255))
            screen.blit(t1, (W // 2 - t1.get_width() // 2, H // 2 - 40))

        pygame.display.flip()
        clock.tick(FPS)

asyncio.run(main())
                    </textarea>
                    <div id="game-console" class="console-area">System waiting...</div>
                </div>

                <div id="game-container" class="game-preview-container">
                    <div class="preview-label" style="text-align:center; font-size:0.8em; color:#aaa; margin-top:10px;">Pygame Surface (900x520)</div>
                    <canvas id="game-canvas" width="900" height="520" tabindex="0"></canvas>
                    <div class="asset-box">
                        <div style="font-size:0.9em; font-weight:bold; color:var(--accent); border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:10px;">ğŸ¤– AI ç´ æè£½ä½œåŠ©ç†</div>
                        <div style="display:flex; gap:8px;"><input id="asset-prompt" placeholder="æè¿°åœ–ç‰‡..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:0.9em;"><button class="btn-primary" style="font-size:0.9em; padding:8px 15px;" onclick="mockGenAsset()">ç”Ÿæˆ</button></div>
                        <div id="asset-list" style="margin-top:10px; display:grid; grid-template-columns:repeat(4,1fr); gap:5px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-evaluate" class="content-area"><h3>ğŸ“Š è©•é‡å„€è¡¨æ¿ (Mock)</h3></div>
        <div id="tab-reflect" class="content-area"><h3>ğŸ¤” åæ€ä¿®æ­£ (Mock)</h3></div>
    </div>

    <script>
        // ============================================
        // V21.0 Config Area (Structure AI Integration)
        // ============================================
        const SYSTEM_CONFIG = {
            // â˜…â˜…â˜… è«‹ä¿®æ”¹é€™è£¡ï¼šå¡«å…¥æ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ â˜…â˜…â˜…
            GAS_URL: "https://script.google.com/macros/s/AKfycbxwM1OYY0WWcdpR8hAVGAk2Lw28O4gMkrm6hyYGACoaJTOyO5VnD_e6iTX_FrrVkhw/exec", 
            STUDENT_ID: ""
        };

        // å…¨åŸŸå°è©±æ­·å²ç´€éŒ„
        let chatHistory = [];

        class BackendService {
            constructor() {}
            
            // å­˜æª”åŠŸèƒ½
            async saveNotes(text) {
                if (!this._checkConfig()) return;
                document.getElementById('save-status').innerText = "åŒæ­¥ä¸­...";
                
                fetch(SYSTEM_CONFIG.GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: "saveNote",
                        studentId: SYSTEM_CONFIG.STUDENT_ID,
                        note: text
                    })
                }).then(() => {
                    document.getElementById('save-status').innerText = "å·²åŒæ­¥";
                }).catch(e => {
                    document.getElementById('save-status').innerText = "åŒæ­¥å¤±æ•—";
                });
            }

            // ä¸€èˆ¬å°è©± (SCAMPER å¼•å°)
            // V21.0: å‚³é scamperType è®“ AI çŸ¥é“æŒ‰éˆ•æ„åœ–
            async callAI(newMsg, role='user', scamperType=null) {
                if (!this._checkConfig()) return "ç³»çµ±æœªè¨­å®š API ç¶²å€";
                
                chatHistory.push({ role: role, text: newMsg });
                const currentNotes = document.getElementById('design-notes').value;

                try {
                    const response = await fetch(SYSTEM_CONFIG.GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "chatAI",
                            history: chatHistory,
                            context: currentNotes,
                            scamperType: scamperType // V21.0 æ–°å¢
                        })
                    });
                    
                    const data = await response.json();
                    if(data.status === "success") {
                        chatHistory.push({ role: 'ai', text: data.text });
                        return data.text;
                    } else {
                        return "AI é€£ç·šéŒ¯èª¤: " + data.message;
                    }
                } catch (e) {
                    console.error(e);
                    return "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²è¨­å®šã€‚";
                }
            }

            // V21.0: çµæ§‹åŒ–æ‘˜è¦ (Summarize for Mind Map)
            async summarize(textToSummarize) {
                if (!this._checkConfig()) return textToSummarize;
                
                try {
                    const response = await fetch(SYSTEM_CONFIG.GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: "summarize",
                            text: textToSummarize
                        })
                    });
                    
                    const data = await response.json();
                    if(data.status === "success") {
                        return data.text;
                    } else {
                        console.error("Summary Error:", data.message);
                        return textToSummarize; // å¤±æ•—å›å‚³åŸå€¼
                    }
                } catch (e) {
                    console.error(e);
                    return textToSummarize;
                }
            }

            _checkConfig() {
                if (!SYSTEM_CONFIG.GAS_URL || SYSTEM_CONFIG.GAS_URL.includes("æ‚¨çš„ID")) {
                    alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š GAS URLï¼");
                    return false;
                }
                return true;
            }
        }
        const backend = new BackendService();

        // ============================================
        // V21.0 UI Logic: Context Aware SCAMPER
        // ============================================
        
        function handleNoteChange() {
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                backend.saveNotes(document.getElementById('design-notes').value);
            }, 1500);
        }

        async function triggerScamper(type) {
            // V21.0: ä¸å†é è¨­å­—ä¸²ï¼Œç›´æ¥æŠŠé¡å‹ä¸Ÿçµ¦ AIï¼Œè®“ AI æ ¹æ“šæ­·å²æ±ºå®šé–‹å ´ç™½
            appendMsg('user', `ğŸ¤” æˆ‘å€‘ä¾†è¨è«–ä¸€ä¸‹ **${type}** ...`);
            const loadingId = appendMsg('ai', 'æ€è€ƒä¸­...');
            
            // é€™è£¡å‚³é€ç©ºå­—ä¸²ä½œç‚º msgï¼Œä½†å¸¶æœ‰ scamperType åƒæ•¸
            const reply = await backend.callAI("", 'user', type);
            
            document.getElementById(loadingId).innerHTML = `
                <span class="msg-label">ğŸ¤– å¤¥ä¼´ (Gemini)</span>
                ${marked.parse(reply)}
                <button class="btn-adopt" onclick="adoptIdea(this)">ğŸ“ åŠ å…¥ç­†è¨˜ (è‡ªå‹•æ•´ç†)</button>
            `;
            const chatBox = document.getElementById('ideate-chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function mockUserResponse() {
            const input = document.getElementById('ideate-input');
            const text = input.value;
            if(!text) return;
            
            appendMsg('user', text);
            input.value = "";
            
            const loadingId = appendMsg('ai', 'æ€è€ƒä¸­...');
            
            const reply = await backend.callAI(text, 'user');
            
            document.getElementById(loadingId).innerHTML = `
                <span class="msg-label">ğŸ¤– å¤¥ä¼´</span>
                ${marked.parse(reply)}
            `;
            const chatBox = document.getElementById('ideate-chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendMsg(role, html) {
            const box = document.getElementById('ideate-chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.id = 'msg-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
            div.innerHTML = role === 'user' ? `<span class="msg-label">æˆ‘</span>${html}` : html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div.id;
        }

        // V21.0: æ™ºæ…§æ•´ç†ç­†è¨˜
        async function adoptIdea(btn) {
            // 1. é–å®šæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            btn.disabled = true;
            btn.innerText = "ğŸ§  AI æ•´ç†ä¸­...";

            // 2. æŠ“å–å°è©±å…§å®¹
            let content = btn.parentElement.innerText;
            content = content.replace("ğŸ¤– å¤¥ä¼´ (Gemini)", "").replace("ğŸ“ åŠ å…¥ç­†è¨˜ (è‡ªå‹•æ•´ç†)", "").trim();
            
            // 3. å‘¼å«å¾Œç«¯é€²è¡Œæ‘˜è¦
            const summarizedText = await backend.summarize(content);

            // 4. å¯«å…¥ç­†è¨˜
            const noteArea = document.getElementById('design-notes');
            noteArea.value += `\n${summarizedText}`;
            noteArea.classList.add('highlight');
            
            // 5. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            btn.innerText = "âœ… å·²åŠ å…¥";
            setTimeout(() => {
                noteArea.classList.remove('highlight');
                // ä¸è§£é™¤ disabledï¼Œé¿å…é‡è¤‡åŠ å…¥åŒä¸€æ¢
            }, 500);
            
            handleNoteChange();
            chatHistory.push({ role: 'user', text: `æˆ‘å·²å°‡é€™å€‹é»å­åŠ å…¥ç­†è¨˜ï¼š${summarizedText}ã€‚è«‹ç¹¼çºŒã€‚` });
        }

        // ============================================
        // Pygame Runtime (V17.2 Full Shim)
        // ============================================
        let pyodide = null;
        let isSystemReady = false;
        window.gameGeneration = 0;
        window.pygameTimers = [];
        window.clearPygameTimers = () => { window.pygameTimers.forEach(id => clearInterval(id)); window.pygameTimers = []; };
        window.setPygameTimer = (eid, ms) => { 
            const id = setInterval(() => { try { pyodide.globals.get('pygame').event._add(eid); } catch(e){} }, ms); 
            window.pygameTimers.push(id); 
        };

        function toggleFullscreen() {
            const elem = document.getElementById('game-container');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => { alert(`Error: ${err.message}`); });
            } else {
                document.exitFullscreen();
            }
        }

        function log(msg) { console.log("[System] " + msg); }

        async function startSystem() {
            const sid = document.getElementById('student-id').value;
            if(!sid) return alert("è«‹è¼¸å…¥å­¸è™Ÿ");
            SYSTEM_CONFIG.STUDENT_ID = sid;

            document.getElementById('login-overlay').style.display = 'none';
            log("ç³»çµ±å•Ÿå‹•ä¸­ (V21.0)...");
            document.getElementById('loading-msg').style.display = 'block';
            
            try {
                pyodide = await loadPyodide();
                log("ä¸‹è¼‰ Numpy & Pillow...");
                await pyodide.loadPackage(["numpy", "Pillow"]);
                
                await pyodide.runPythonAsync(`
                    import sys
                    from js import console
                    class WebOut:
                        def write(self, s):
                            js.document.getElementById('game-console').innerText += s
                            console.log("PY: " + s)
                        def flush(self): pass
                    sys.stdout = WebOut()
                    sys.stderr = WebOut()
                `);

                await initV21Pygame(); 

                log("Python ç’°å¢ƒå°±ç·’");
                isSystemReady = true;
                const btn = document.getElementById('btn-run');
                btn.disabled = false;
                btn.innerText = "â–¶ åŸ·è¡Œä»£ç¢¼";
            } catch(e) {
                log("Python è¼‰å…¥å¤±æ•—: " + e.message);
                console.error(e);
            }
        }

        async function initV21Pygame() {
            const pygameShim = `
import js
import sys
import types
import math
import time
import asyncio

requests = types.ModuleType("requests")
requests.get = lambda u: types.SimpleNamespace(status_code=200, text="Mock", json=lambda: {})
sys.modules["requests"] = requests
socket = types.ModuleType("socket")
socket.socket = lambda *a: None
sys.modules["socket"] = socket

pygame = types.ModuleType("pygame")
sys.modules["pygame"] = pygame
pygame._active_gen = 0 

if not hasattr(asyncio, '_orig_sleep'): asyncio._orig_sleep = asyncio.sleep
async def _monkey_sleep(delay=0, result=None):
    await asyncio._orig_sleep(delay, result)
    if pygame._active_gen != js.window.gameGeneration: raise SystemExit("Stop")
asyncio.sleep = _monkey_sleep
async def _web_sync(): await asyncio.sleep(0)
async def _wait_frame(fps):
    if fps <= 0: await asyncio.sleep(0); return
    await asyncio.sleep(1.0 / fps)

pygame._web_sync = _web_sync
pygame.time_wait_frame = _wait_frame

pygame.QUIT = 12
pygame.KEYDOWN = 2
pygame.KEYUP = 3
pygame.MOUSEMOTION = 4
pygame.MOUSEBUTTONDOWN = 5
pygame.MOUSEBUTTONUP = 6
pygame.USEREVENT = 24
pygame.SRCALPHA = 65536 
pygame.K_LEFT, pygame.K_RIGHT, pygame.K_UP, pygame.K_DOWN = "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"
pygame.K_SPACE, pygame.K_ESCAPE, pygame.K_RETURN = "Space", "Escape", "Enter"
for c in range(97, 123): setattr(pygame, f"K_{chr(c)}", f"Key{chr(c).upper()}")

class Rect:
    def __init__(self, x, y, w, h): self.x, self.y, self.w, self.h = x, y, w, h
    @property
    def left(self): return self.x
    @left.setter
    def left(self, v): self.x = v
    @property
    def right(self): return self.x + self.w
    @right.setter
    def right(self, v): self.x = v - self.w
    @property
    def top(self): return self.y
    @top.setter
    def top(self, v): self.y = v
    @property
    def bottom(self): return self.y + self.h
    @bottom.setter
    def bottom(self, v): self.y = v - self.h
    @property
    def width(self): return self.w
    @width.setter
    def width(self, v): self.w = v
    @property
    def height(self): return self.h
    @height.setter
    def height(self, v): self.h = v
    @property
    def size(self): return (self.w, self.h)
    @size.setter
    def size(self, s): self.w, self.h = s
    @property
    def topleft(self): return (self.x, self.y)
    @topleft.setter
    def topleft(self, p): self.x, self.y = p
    @property
    def centerx(self): return self.x + self.w / 2
    @centerx.setter
    def centerx(self, v): self.x = v - self.w / 2
    @property
    def centery(self): return self.y + self.h / 2
    @centery.setter
    def centery(self, v): self.y = v - self.h / 2
    @property
    def center(self): return (self.centerx, self.centery)
    @center.setter
    def center(self, p): self.x = p[0] - self.w/2; self.y = p[1] - self.h/2
    def colliderect(self, o): return (self.x < o.x + o.w and self.x + self.w > o.x and self.y < o.y + o.h and self.y + self.h > o.y)
    def collidelist(self, rects):
        for i, r in enumerate(rects):
            if self.colliderect(r): return i
        return -1
    def copy(self): return Rect(self.x, self.y, self.w, self.h)
pygame.Rect = Rect

class Surface:
    def __init__(self, size, flags=0, depth=0): 
        if isinstance(size, (tuple, list)): self.width, self.height = size
        else: self.width, self.height = size, flags
        self.is_screen = False
        self.alpha = 255
    def fill(self, color, rect=None, special_flags=0):
        if self.is_screen:
            ctx = js.document.getElementById("game-canvas").getContext("2d")
            c = color if len(color)==3 else color[:3]
            a = color[3]/255 if len(color)==4 else 1.0
            ctx.fillStyle = f"rgba({c[0]},{c[1]},{c[2]},{a})"
            if rect:
                rx, ry, rw, rh = (rect.x, rect.y, rect.w, rect.h) if isinstance(rect, Rect) else rect
                ctx.fillRect(rx, ry, rw, rh)
            else:
                ctx.fillRect(0, 0, self.width, self.height)
    def blit(self, source, dest):
        if self.is_screen:
            ctx = js.document.getElementById("game-canvas").getContext("2d")
            if hasattr(source, 'text_content'):
                ctx.save()
                ctx.fillStyle = source.color_str
                ctx.font = source.font_str
                ctx.textBaseline = "top" 
                ctx.fillText(source.text_content, dest[0], dest[1])
                ctx.restore()
            elif isinstance(source, Surface):
                ctx.save()
                if hasattr(source, 'alpha'): ctx.globalAlpha = source.alpha / 255.0
                ctx.fillStyle = "black"
                ctx.fillRect(dest[0], dest[1], source.width, source.height)
                ctx.restore()
    def set_alpha(self, a): self.alpha = a
    def get_width(self): return self.width
    def get_height(self): return self.height

class Display:
    def set_mode(self, size):
        canvas = js.document.getElementById("game-canvas")
        canvas.width = size[0]
        canvas.height = size[1]
        s = Surface(size)
        s.is_screen = True
        return s
    def set_caption(self, t): pass
    def flip(self): pass 
pygame.display = Display()
pygame.Surface = Surface

class Draw:
    def ellipse(self, surf, color, r):
        ctx = js.document.getElementById("game-canvas").getContext("2d")
        c = color if len(color)==3 else color[:3]
        ctx.fillStyle = f"rgb({c[0]},{c[1]},{c[2]})"
        ctx.beginPath()
        x, y, w, h = (r.x, r.y, r.w, r.h) if isinstance(r, Rect) else r
        ctx.ellipse(x + w/2, y + h/2, w/2, h/2, 0, 0, 6.28)
        ctx.fill()
    def line(self, surf, color, start, end, width=1):
        ctx = js.document.getElementById("game-canvas").getContext("2d")
        c = color if len(color)==3 else color[:3]
        ctx.strokeStyle = f"rgb({c[0]},{c[1]},{c[2]})"
        ctx.lineWidth = width
        ctx.beginPath()
        ctx.moveTo(start[0], start[1])
        ctx.lineTo(end[0], end[1])
        ctx.stroke()
    def rect(self, surf, color, r, width=0, border_radius=0):
        ctx = js.document.getElementById("game-canvas").getContext("2d")
        c = color if len(color)==3 else color[:3]
        ctx.fillStyle = f"rgb({c[0]},{c[1]},{c[2]})"
        x, y, w, h = (r.x, r.y, r.w, r.h) if isinstance(r, Rect) else r
        ctx.beginPath()
        if hasattr(ctx, 'roundRect'): ctx.roundRect(x, y, w, h, border_radius)
        else: ctx.rect(x, y, w, h)
        ctx.fill()
    def circle(self, surf, color, center, radius):
        ctx = js.document.getElementById("game-canvas").getContext("2d")
        c = color if len(color)==3 else color[:3]
        ctx.fillStyle = f"rgb({c[0]},{c[1]},{c[2]})"
        ctx.beginPath()
        ctx.arc(center[0], center[1], radius, 0, 6.28)
        ctx.fill()
pygame.draw = Draw()

class Key:
    def __init__(self): self.pressed = {}
    class PressedWrapper:
        def __init__(self, d): self.d = d
        def __getitem__(self, k): return self.d.get(k, False)
    def get_pressed(self): return self.PressedWrapper(self.pressed)
    def _set_key(self, key, state): self.pressed[key] = state
    def _clear(self): self.pressed = {}
pygame.key = Key()

class Mouse:
    def __init__(self): 
        self.pos = (0,0)
        self.pressed = (False, False, False)
    def get_pos(self): return self.pos
    def get_pressed(self): return self.pressed
    def set_visible(self, b): pass
    def _set_pos(self, p): self.pos = p
    def _set_btn(self, idx, state):
        p = list(self.pressed)
        p[idx] = state
        self.pressed = tuple(p)
pygame.mouse = Mouse()

class FontObj:
    def __init__(self, n, s): self.n, self.s = n, s
    def render(self, t, a, c):
        s = Surface(10,10); s.text_content = t; 
        r, g, b = c if len(c)==3 else c[:3]
        s.color_str = f"rgb({r},{g},{b})"
        font_name = "Arial" if self.n is None else self.n
        s.font_str = f"{self.s}px {font_name}"
        return s
    def get_width(self): return 100 
class FontModule:
    def SysFont(self, n, s): return FontObj(n, s)
pygame.font = FontModule()

class Time:
    class Clock:
        def tick(self, fps): return 0 
    def set_timer(self, eid, ms): js.window.setPygameTimer(eid, ms)
    def get_ticks(self): return int(js.performance.now())
pygame.time = Time()

class EventObj:
    def __init__(self, t, **kwargs): self.type = t; self.__dict__.update(kwargs)
class EventMod:
    def __init__(self): self.q = []
    def get(self): r = self.q[:]; self.q = []; return r
    def _add(self, t, **kwargs): self.q.append(EventObj(t, **kwargs))
    def clear(self): self.q = []
pygame.event = EventMod()

pygame.math = types.ModuleType("pygame.math")
class Vector2:
    def __init__(self, x=0, y=0): self.x, self.y = x, y
pygame.math.Vector2 = Vector2

pygame.transform = types.ModuleType("pygame.transform")
pygame.transform.rotate = lambda s, a: s
pygame.transform.scale = lambda s, z: s

pygame.init = lambda: (6,0)
def _exit_func(): raise SystemExit()
pygame.quit = lambda: None

sys_mod = types.ModuleType("sys")
sys_mod.exit = _exit_func
sys.modules["sys"] = sys_mod

def _fake_run(coro): return coro
asyncio.run = _fake_run

def _js_key(k, d):
    pygame.key._set_key(k, d)
    if d: pygame.event._add(pygame.KEYDOWN, key=k)
    else: pygame.event._add(pygame.KEYUP, key=k)

def _js_mouse_move(x, y):
    pygame.mouse._set_pos((x, y))

def _js_mouse_btn(btn, down):
    py_btn = [1, 2, 3][btn]
    pygame.mouse._set_btn(btn, down)
    t = pygame.MOUSEBUTTONDOWN if down else pygame.MOUSEBUTTONUP
    pygame.event._add(t, button=py_btn, pos=pygame.mouse.get_pos())
            `;
            await pyodide.runPythonAsync(pygameShim);
            window.addEventListener('keydown', (e) => { try { pyodide.globals.get('_js_key')(e.code, true); } catch(e){} });
            window.addEventListener('keyup', (e) => { try { pyodide.globals.get('_js_key')(e.code, false); } catch(e){} });
            const canvas = document.getElementById('game-canvas');
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                try { pyodide.globals.get('_js_mouse_move')(x, y); } catch(e){}
            });
            canvas.addEventListener('mousedown', (e) => { try { pyodide.globals.get('_js_mouse_btn')(e.button, true); } catch(e){} });
            canvas.addEventListener('mouseup', (e) => { try { pyodide.globals.get('_js_mouse_btn')(e.button, false); } catch(e){} });
        }

        async function runGame() {
            if(!isSystemReady) return alert("ç³»çµ±è¼‰å…¥ä¸­...");
            
            const consoleBox = document.getElementById('game-console');
            consoleBox.innerText = "Restarting game...\n";
            window.gameGeneration++;
            window.clearPygameTimers();
            await pyodide.runPythonAsync(`pygame.event.clear(); pygame.key._clear(); pygame._active_gen = ${window.gameGeneration}`);
            consoleBox.innerText += "Gen " + window.gameGeneration + " Started.\n";
            
            document.getElementById('btn-start').blur();
            document.getElementById('btn-run').blur();
            document.getElementById('btn-fullscreen').blur();
            
            let code = document.getElementById('game-code').value;
            if(!code.includes("import asyncio")) code = "import asyncio\n" + code;
            if(!code.match(/async\s+def\s+main/)) code = code.replace(/def\s+main\s*\(\)\s*:/g, "async def main():");
            if (code.includes("asyncio.run(main())")) code = code.replace("asyncio.run(main())", "await main()");
            else code = code.replace(/if\s+__name__\s*==\s*"?__main__"?\s*:\s*main\(\)/g, 'if __name__ == "__main__":\n    await main()');
            
            const regexTick = /(\S+)\.tick\s*\(([^)]+)\)/;
            if (code.match(regexTick)) code = code.replace(regexTick, "await pygame.time_wait_frame($2)");
            if (code.includes("pygame.display.flip()")) code = code.replace(/pygame\.display\.flip\(\)/g, "await pygame._web_sync()\n        pygame.display.flip()");

            setTimeout(() => document.getElementById('game-canvas').focus(), 100);

            try {
                await pyodide.runPythonAsync(code);
                consoleBox.innerText += "\n[Execution Finished]";
            } catch(err) {
                if (!err.message.includes("SystemExit")) consoleBox.innerText += "\nRuntime Error: " + err.message;
                else consoleBox.innerText += "\n[Game Stopped]";
            }
        }

        function stopGame() { 
            window.gameGeneration++;
            window.clearPygameTimers();
            document.getElementById('game-console').innerText += "\n[Stop Signal Sent]"; 
        }
        
        function mockGenAsset() { /* Future: Call GAS to gen image */ }
        function switchTab(id) { 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${id}`).classList.add('active');
        }
    </script>
</body>
</html>
